name: AI æ—¥æŠ¥æ•°æ®æ”¶é›†

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹ (åŒ—äº¬æ—¶é—´)
  schedule:
    - cron: '0 0 * * *'    # æ—©ä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 0ç‚¹)
    - cron: '0 12 * * *'   # æ™šä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 12ç‚¹)
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sources:
        description: 'æŒ‡å®šçˆ¬å–æº (å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚: arxiv,github)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arxiv
          - github
          - rss
          - papers-with-code
          - stackoverflow
          - arxiv,github
          - arxiv,rss
          - github,rss
      use_source_config:
        description: 'ä½¿ç”¨æ™ºèƒ½æºé…ç½® (æ¨è)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      max_results:
        description: 'ç»Ÿä¸€æœ€å¤§ç»“æœæ•° (ä»…å½“å…³é—­æ™ºèƒ½é…ç½®æ—¶ä½¿ç”¨)'
        required: false
        default: '10'
        type: string
      continue_on_error:
        description: 'é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–æº'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  collect-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: å®‰è£…ä¾èµ–
        run: pnpm install
      
      - name: ç¼–è¯‘ TypeScript çˆ¬è™«
        run: |
          echo "å¼€å§‹ç¼–è¯‘ TypeScript æ–‡ä»¶..."
          rm -rf dist/scripts/
          mkdir -p dist/scripts/
          npx tsc scripts/collectDataToSupabase.ts --outDir dist/scripts --module commonjs --target es2020 --esModuleInterop true --allowSyntheticDefaultImports true --skipLibCheck true --declaration false
          echo "ç¼–è¯‘å®Œæˆ"
          ls -la dist/scripts/scripts/
      
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
      
      - name: éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."
          echo "SUPABASE_URL: ${SUPABASE_URL:0:20}..."
          echo "SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:0:20}..."
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:0:20}..."
          echo "GH_TOKEN: ${GH_TOKEN:0:20}..."
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: è¿è¡Œæ•°æ®æ”¶é›†
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "å¼€å§‹è¿è¡Œæ•°æ®æ”¶é›†..."
          
          # æ„å»ºå‘½ä»¤å‚æ•°
          SOURCES="${{ github.event.inputs.sources || 'all' }}"
          USE_SOURCE_CONFIG="${{ github.event.inputs.use_source_config || 'true' }}"
          MAX_RESULTS="${{ github.event.inputs.max_results || '10' }}"
          CONTINUE_ON_ERROR="${{ github.event.inputs.continue_on_error || 'true' }}"
          
          CMD="node dist/scripts/scripts/collectDataToSupabase.js"
          CMD="$CMD --sources=$SOURCES"
          CMD="$CMD --timeout=25"
          CMD="$CMD --verbose"
          
          if [ "$USE_SOURCE_CONFIG" = "true" ]; then
            CMD="$CMD --use-source-config"
          else
            CMD="$CMD --max-results=$MAX_RESULTS"
          fi
          
          if [ "$CONTINUE_ON_ERROR" = "true" ]; then
            CMD="$CMD --continue-on-error"
          fi
          
          echo "æ‰§è¡Œå‘½ä»¤: $CMD"
          eval $CMD
      
      - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸ¤– AIæ—¥æŠ¥æ•°æ®æ”¶é›†æŠ¥å‘Š" > report.md
          echo "" >> report.md
          echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> report.md
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> report.md
          echo "**æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> report.md
          echo "" >> report.md
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "### ğŸ”§ æ‰‹åŠ¨é…ç½®" >> report.md
            echo "- **æŒ‡å®šæº**: ${{ github.event.inputs.sources || 'all' }}" >> report.md
            echo "- **æ™ºèƒ½é…ç½®**: ${{ github.event.inputs.use_source_config || 'true' }}" >> report.md
            echo "- **ç»§ç»­æ‰§è¡Œ**: ${{ github.event.inputs.continue_on_error || 'true' }}" >> report.md
            if [ "${{ github.event.inputs.use_source_config || 'true' }}" = "false" ]; then
              echo "- **ç»Ÿä¸€ç»“æœæ•°**: ${{ github.event.inputs.max_results || '10' }}" >> report.md
            fi
            echo "" >> report.md
          fi
          
          if [ -f collection_log.txt ]; then
            echo "### ğŸ“Š æ”¶é›†ç»Ÿè®¡" >> report.md
            echo '```' >> report.md
            cat collection_log.txt >> report.md
            echo '```' >> report.md
          else
            echo "### ğŸ“Š æ”¶é›†ç»Ÿè®¡" >> report.md
            echo "æœªæ‰¾åˆ°æ”¶é›†æ—¥å¿—æ–‡ä»¶" >> report.md
          fi
          
          echo "### ğŸ“ è¯¦ç»†æ—¥å¿—" >> report.md
          echo "è¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–å®Œæ•´çš„æ‰§è¡Œè¯¦æƒ…" >> report.md
          
          cat report.md
      
      - name: æ£€æŸ¥æ•°æ®æ”¶é›†ç»“æœ
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "æ£€æŸ¥æ•°æ®åº“ä¸­æœ€æ–°æ”¶é›†çš„æ•°æ®..."
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY);
          
          (async () => {
            try {
              const { data, error } = await supabase
                .from('articles')
                .select('source_type, created_at')
                .gte('created_at', new Date(Date.now() - 3600000).toISOString()) // æœ€è¿‘1å°æ—¶
                .order('created_at', { ascending: false });
                
              if (error) throw error;
              
              console.log('âœ… æœ€è¿‘1å°æ—¶æ”¶é›†çš„æ•°æ®:');
              const counts = {};
              data.forEach(article => {
                counts[article.source_type] = (counts[article.source_type] || 0) + 1;
              });
              
              Object.entries(counts).forEach(([source, count]) => {
                console.log('  -', source + ':', count, 'ç¯‡');
              });
              
              console.log('æ€»è®¡:', data.length, 'ç¯‡æ–‡ç« ');
            } catch (error) {
              console.error('âŒ æ£€æŸ¥æ•°æ®æ—¶å‡ºé”™:', error.message);
            }
          })();
          "
      
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… æ•°æ®æ”¶é›†ä»»åŠ¡æˆåŠŸå®Œæˆ"
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
      
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ æ•°æ®æ”¶é›†ä»»åŠ¡å¤±è´¥"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          echo "å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')" 