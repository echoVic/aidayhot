name: AI æ—¥æŠ¥æ•°æ®æ”¶é›†

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹ (åŒ—äº¬æ—¶é—´)
  schedule:
    - cron: '0 0 * * *'    # æ—©ä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 0ç‚¹)
    - cron: '0 12 * * *'   # æ™šä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 12ç‚¹)
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sources:
        description: 'æŒ‡å®šçˆ¬å–æº (å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚: arxiv,github)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arxiv
          - github
          - rss
          - papers-with-code
          - stackoverflow
          - arxiv,github
          - arxiv,rss
          - github,rss
      use_source_config:
        description: 'ä½¿ç”¨æ™ºèƒ½æºé…ç½® (æ¨è)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      max_results:
        description: 'ç»Ÿä¸€æœ€å¤§ç»“æœæ•° (ä»…å½“å…³é—­æ™ºèƒ½é…ç½®æ—¶ä½¿ç”¨)'
        required: false
        default: '50'
        type: string
      continue_on_error:
        description: 'é‡åˆ°é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–æº'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      hours_back:
        description: 'æ”¶é›†å‰Nå°æ—¶çš„æ•°æ® (0è¡¨ç¤ºä¸ä½¿ç”¨æ—¶é—´è¿‡æ»¤)'
        required: false
        default: '12'
        type: number
      runner_type:
        description: 'Runner ç±»å‹é€‰æ‹©'
        required: false
        default: 'github-hosted'
        type: choice
        options:
          - 'github-hosted'
          - 'self-hosted'

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè§£ææ•°æ®æº
  prepare:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      sources: ${{ steps.parse-sources.outputs.sources }}
    
    steps:
      - name: è§£ææ•°æ®æº
        id: parse-sources
        run: |
          SOURCES_INPUT="${{ github.event.inputs.sources || 'all' }}"
          echo "è¾“å…¥çš„æ•°æ®æº: $SOURCES_INPUT"
          
          if [ "$SOURCES_INPUT" = "all" ]; then
            # æ‹†åˆ†æ‰€æœ‰å¯ç”¨æ•°æ®æº
            ALL_SOURCES=("arxiv" "github" "rss" "papers-with-code" "stackoverflow")
            SOURCES_JSON="["
            for i in "${!ALL_SOURCES[@]}"; do
              if [ $i -gt 0 ]; then
                SOURCES_JSON+=","
              fi
              SOURCES_JSON+="\"${ALL_SOURCES[$i]}\""
            done
            SOURCES_JSON+="]"
            
            echo "sources=$SOURCES_JSON" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨ Matrix æ¨¡å¼å¤„ç†æ‰€æœ‰æ•°æ®æº: $SOURCES_JSON"
          else
            # æ‹†åˆ†æŒ‡å®šçš„å¤šä¸ªæ•°æ®æº
            IFS=',' read -ra SOURCE_ARRAY <<< "$SOURCES_INPUT"
            SOURCES_JSON="["
            for i in "${!SOURCE_ARRAY[@]}"; do
              SOURCE=$(echo "${SOURCE_ARRAY[$i]}" | xargs)  # å»é™¤ç©ºæ ¼
              if [ $i -gt 0 ]; then
                SOURCES_JSON+=","
              fi
              SOURCES_JSON+="\"$SOURCE\""
            done
            SOURCES_JSON+="]"
            
            echo "sources=$SOURCES_JSON" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨ Matrix æ¨¡å¼å¤„ç†æŒ‡å®šæ•°æ®æº: $SOURCES_JSON"
          fi

  # æ•°æ®æ”¶é›†ä»»åŠ¡
  collect-data:
    needs: prepare
    # åŠ¨æ€é€‰æ‹© runner ç±»å‹
    runs-on: ${{ github.event.inputs.runner_type == 'self-hosted' && 'self-hosted' || 'ubuntu-22.04' }}
    timeout-minutes: 20    # å•ä¸ªæ•°æ®æºè¶…æ—¶æ—¶é—´å‡å°‘
    
    # åŠ¨æ€ matrix ç­–ç•¥
    strategy:
      fail-fast: ${{ github.event.inputs.continue_on_error != 'true' }}
      matrix:
        source: ${{ fromJson(needs.prepare.outputs.sources) }}
    
    # æ·»åŠ ç¯å¢ƒä¼˜åŒ–
    env:
      NODE_OPTIONS: '--max-old-space-size=4096'  # å¢åŠ  Node.js å†…å­˜é™åˆ¶
      FORCE_COLOR: '1'  # å¼ºåˆ¶å½©è‰²è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          echo "å®‰è£…ä¾èµ–å¼€å§‹æ—¶é—´: $(date)"
          pnpm install
          echo "å®‰è£…ä¾èµ–å®Œæˆæ—¶é—´: $(date)"
      
      - name: æ£€æŸ¥è„šæœ¬æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥ TypeScript è„šæœ¬æ–‡ä»¶..."
          ls -la scripts/collectDataToSupabase.ts
          ls -la scripts/updateCategoryStats.ts
          echo "âœ… è„šæœ¬æ–‡ä»¶ç¡®è®¤å­˜åœ¨"
      
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          echo "CURRENT_SOURCE=${{ matrix.source }}" >> $GITHUB_ENV
      
      - name: ç¯å¢ƒä¿¡æ¯
        run: |
          echo "Node.js: $(node --version)"
          echo "pnpm: $(pnpm --version)"
          echo "ç³»ç»Ÿ: $(uname -r)"
          echo "å½“å‰å¤„ç†æ•°æ®æº: ${{ matrix.source }}"
      
      - name: éªŒè¯ç¯å¢ƒå˜é‡
        run: |
          echo "éªŒè¯å…³é”®ç¯å¢ƒå˜é‡..."
          [ -n "$SUPABASE_URL" ] && echo "âœ… SUPABASE_URL" || echo "âŒ SUPABASE_URL"
          [ -n "$SUPABASE_ANON_KEY" ] && echo "âœ… SUPABASE_ANON_KEY" || echo "âŒ SUPABASE_ANON_KEY"
          [ -n "$SUPABASE_SERVICE_ROLE_KEY" ] && echo "âœ… SUPABASE_SERVICE_ROLE_KEY" || echo "âŒ SUPABASE_SERVICE_ROLE_KEY"
          [ -n "$GH_TOKEN" ] && echo "âœ… GH_TOKEN" || echo "âŒ GH_TOKEN"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: è¿è¡Œæ•°æ®æ”¶é›† - ${{ matrix.source }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "å¼€å§‹è¿è¡Œæ•°æ®æ”¶é›† - æ•°æ®æº: ${{ matrix.source }}"
          
          # æ„å»ºå‘½ä»¤å‚æ•°
          CURRENT_SOURCE="${{ matrix.source }}"
          USE_SOURCE_CONFIG="${{ github.event.inputs.use_source_config || 'true' }}"
          MAX_RESULTS="${{ github.event.inputs.max_results || '50' }}"
          HOURS_BACK="${{ github.event.inputs.hours_back || '12' }}"
          
          # ä½¿ç”¨tsxç›´æ¥è¿è¡ŒTypeScriptè„šæœ¬
          CMD="npx tsx scripts/collectDataToSupabase.ts"
          CMD="$CMD --sources=$CURRENT_SOURCE"
          CMD="$CMD --timeout=20"
          CMD="$CMD --verbose"
          CMD="$CMD --continue-on-error"
          
          # æ·»åŠ æ—¶é—´è¿‡æ»¤åŠŸèƒ½
          if [ "$HOURS_BACK" != "0" ]; then
            CMD="$CMD --hours-back=$HOURS_BACK"
            echo "ğŸ• å¯ç”¨æ—¶é—´è¿‡æ»¤: å‰ $HOURS_BACK å°æ—¶"
          fi
          
          if [ "$USE_SOURCE_CONFIG" = "true" ]; then
            echo "ğŸ¯ ä½¿ç”¨æ™ºèƒ½æºé…ç½®"
          else
            CMD="$CMD --max-results=$MAX_RESULTS"
            echo "ğŸ“Š ä½¿ç”¨ç»Ÿä¸€é…ç½®: $MAX_RESULTS æ¡ç»“æœ"
          fi
          
          echo "æ‰§è¡Œå‘½ä»¤: $CMD"
          eval $CMD
      
      - name: æ›´æ–°åˆ†ç±»ç»Ÿè®¡ - ${{ matrix.source }}
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "å¼€å§‹æ›´æ–°åˆ†ç±»ç»Ÿè®¡..."
          
          # ç›´æ¥ä½¿ç”¨tsxè¿è¡ŒTypeScriptè„šæœ¬
          echo "æ‰§è¡Œåˆ†ç±»ç»Ÿè®¡æ›´æ–°..."
          npx tsx scripts/updateCategoryStats.ts --verbose || echo "âš ï¸ åˆ†ç±»ç»Ÿè®¡æ›´æ–°å¤±è´¥ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹"
      
      - name: ä¸Šä¼ æ•°æ®æ”¶é›†æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collection-log-${{ matrix.source }}
          path: collection_log.txt
          retention-days: 7
      
      - name: ä»»åŠ¡å®ŒæˆçŠ¶æ€ - ${{ matrix.source }}
        if: always()
        run: |
          echo "=== æ•°æ®æº ${{ matrix.source }} æ‰§è¡Œå®Œæˆ ==="
          echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ -f collection_log.txt ]; then
            echo "æ”¶é›†ç»“æœæ¦‚è§ˆ:"
            tail -10 collection_log.txt
          fi

  # æ±‡æ€»ä»»åŠ¡
  summary:
    needs: [prepare, collect-data]
    runs-on: ubuntu-22.04
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ—¥å¿—
        uses: actions/download-artifact@v4
        with:
          path: logs/
      
      - name: ç”Ÿæˆæ‰§è¡Œæ±‡æ€»
        run: |
          echo "=== AI æ—¥æŠ¥æ•°æ®æ”¶é›†æ‰§è¡Œæ±‡æ€» ==="
          echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å¤„ç†çš„æ•°æ®æº: ${{ needs.prepare.outputs.sources }}"
          echo "æ‰§è¡Œæ¨¡å¼: Matrix å¹¶è¡Œå¤„ç†"
          echo ""
          
          # ç»Ÿè®¡å„æ•°æ®æºæ‰§è¡Œç»“æœ
          if [ -d "logs" ]; then
            echo "å„æ•°æ®æºæ‰§è¡Œç»“æœ:"
            for log_dir in logs/collection-log-*/; do
              if [ -d "$log_dir" ]; then
                source_name=$(basename "$log_dir" | sed 's/collection-log-//')
                echo "ğŸ“Š æ•°æ®æº: $source_name"
                if [ -f "$log_dir/collection_log.txt" ]; then
                  echo "   æœ€åå‡ è¡Œæ—¥å¿—:"
                  tail -3 "$log_dir/collection_log.txt" | sed 's/^/   /'
                else
                  echo "   âŒ æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
                fi
                echo ""
              fi
            done
          else
            echo "æœªæ‰¾åˆ°æ—¥å¿—ç›®å½•"
          fi 