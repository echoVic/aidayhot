name: AI æ—¥æŠ¥æ•°æ®æ”¶é›†

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹ (åŒ—äº¬æ—¶é—´)
  schedule:
    - cron: '0 0 * * *'    # æ—©ä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 0ç‚¹)
    - cron: '0 12 * * *'   # æ™šä¸Š8ç‚¹åŒ—äº¬æ—¶é—´ (UTC 12ç‚¹)
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sources:
        description: 'æŒ‡å®šçˆ¬å–æº (arxiv,github,papers-with-code,stackoverflow,rss æˆ– all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arxiv
          - github
          - papers-with-code
          - stackoverflow
          - rss
      use_smart_config:
        description: 'ä½¿ç”¨æ™ºèƒ½æºé…ç½® (æ¨è)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      max_results:
        description: 'ç»Ÿä¸€æœ€å¤§ç»“æœæ•° (ä»…å½“å…³é—­æ™ºèƒ½é…ç½®æ—¶ä½¿ç”¨)'
        required: false
        default: '10'
        type: string

jobs:
  collect-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: å®‰è£…ä¾èµ–
        run: pnpm install
      
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
      
      - name: è¿è¡Œæ•°æ®æ”¶é›†
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.use_smart_config || 'true' }}" = "true" ]; then
            node scripts/collectDataToSupabase.js \
              --sources="${{ github.event.inputs.sources || 'all' }}" \
              --timeout=25 \
              --verbose
          else
            node scripts/collectDataToSupabase.js \
              --sources="${{ github.event.inputs.sources || 'all' }}" \
              --max-results="${{ github.event.inputs.max_results || '10' }}" \
              --timeout=25 \
              --verbose
          fi
      
      - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "## ğŸ¤– AIæ—¥æŠ¥æ•°æ®æ”¶é›†æŠ¥å‘Š" > report.md
          echo "" >> report.md
          echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> report.md
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> report.md
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**æŒ‡å®šæº**: ${{ github.event.inputs.sources || 'all' }}" >> report.md
            echo "**æ™ºèƒ½é…ç½®**: ${{ github.event.inputs.use_smart_config || 'true' }}" >> report.md
            if [ "${{ github.event.inputs.use_smart_config || 'true' }}" = "false" ]; then
              echo "**ç»Ÿä¸€ç»“æœæ•°**: ${{ github.event.inputs.max_results || '10' }}" >> report.md
            fi
          fi
          echo "**æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> report.md
          echo "" >> report.md
          
          if [ -f collection_log.txt ]; then
            echo "### ğŸ“Š æ”¶é›†ç»Ÿè®¡" >> report.md
            echo '```' >> report.md
            cat collection_log.txt >> report.md
            echo '```' >> report.md
          fi
          
          cat report.md
      
      - name: å‘é€é€šçŸ¥ (å¤±è´¥æ—¶)
        if: failure()
        run: |
          echo "âŒ æ•°æ®æ”¶é›†ä»»åŠ¡å¤±è´¥"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          echo "å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')" 